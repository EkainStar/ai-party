<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AI Party</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0f; --surface:#111118; --surface2:#18181f; --border:#2a2a35;
  --accent-a:#7c3aed; --accent-b:#0ea5e9;
  --text:#e8e8f0; --text-dim:#6b6b80; --text-muted:#3a3a4a;
  --glow-a:rgba(124,58,237,.4); --glow-b:rgba(14,165,233,.4);
  --sidebar-w:310px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;height:100dvh;overflow:hidden}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(124,58,237,.03)1px,transparent 1px),linear-gradient(90deg,rgba(124,58,237,.03)1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

/* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;background:rgba(5,5,10,.92);backdrop-filter:blur(8px)}
.overlay.hidden{display:none}
.hidden{display:none!important}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:36px 32px;width:min(460px,92vw);display:flex;flex-direction:column;gap:18px;max-height:90dvh;overflow-y:auto}
.card::-webkit-scrollbar{width:3px}
.card::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.card-title{font-size:1.3rem;font-weight:800;letter-spacing:-.02em}
.card-sub{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text-dim);line-height:1.5}
.pin-input{font-family:'IBM Plex Mono',monospace;font-size:1.6rem;letter-spacing:.3em;text-align:center;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);padding:12px;width:100%;outline:none;transition:border-color .2s}
.pin-input:focus{border-color:var(--accent-a)}
.card-error{font-family:'IBM Plex Mono',monospace;font-size:.65rem;color:#ef4444;min-height:16px}
.card-divider{height:1px;background:var(--border)}
.card-hint{font-family:'IBM Plex Mono',monospace;font-size:.62rem;color:var(--text-muted);text-align:center}
.card-hint b{color:var(--text-dim);cursor:pointer;text-decoration:underline}
.config-notice{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.2);border-radius:8px;padding:10px 12px;font-family:'IBM Plex Mono',monospace;font-size:.62rem;color:var(--accent-b);line-height:1.6}
.config-notice code{background:rgba(14,165,233,.15);border-radius:3px;padding:1px 5px}
.keys-list{display:flex;flex-direction:column;gap:6px}
.key-row{display:flex;gap:6px;align-items:center}
.key-row input{flex:1;font-family:'IBM Plex Mono',monospace;font-size:.68rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:6px 9px;outline:none;transition:border-color .18s}
.key-row input:focus{border-color:var(--accent-a)}
.key-row .key-status{font-family:'IBM Plex Mono',monospace;font-size:.6rem;white-space:nowrap;padding:3px 7px;border-radius:10px;border:1px solid var(--border);color:var(--text-muted)}
.key-row .key-status.ok{border-color:rgba(34,197,94,.4);color:#22c55e}
.key-row button.del-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;padding:5px 9px;font-size:.75rem;cursor:pointer;flex-shrink:0}
.key-row button.del-btn:hover{border-color:#ef4444;color:#ef4444}
.btn-row{display:flex;gap:8px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{flex-shrink:0;height:56px;z-index:20;padding:0 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(10,10,15,.92);backdrop-filter:blur(12px)}
.logo{font-size:1rem;font-weight:800;letter-spacing:-.02em;display:flex;align-items:center;gap:9px}
.logo-icon{width:26px;height:26px;background:linear-gradient(135deg,var(--accent-a),var(--accent-b));border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px}
.header-right{display:flex;align-items:center;gap:8px}
.hdr-btn{font-family:'IBM Plex Mono',monospace;font-size:.6rem;padding:3px 10px;border-radius:20px;border:1px solid var(--border);color:var(--text-dim);letter-spacing:.06em;cursor:pointer;background:transparent;transition:all .18s}
.hdr-btn:hover{border-color:var(--text-dim);color:var(--text)}
.hdr-btn.keys-btn{border-color:rgba(14,165,233,.4);color:var(--accent-b)}
.hdr-btn.keys-btn:hover{border-color:var(--accent-b);background:rgba(14,165,233,.08)}
.status-pill{font-family:'IBM Plex Mono',monospace;font-size:.6rem;padding:3px 9px;border-radius:20px;border:1px solid var(--border);color:var(--text-dim);letter-spacing:.06em}
.status-pill.running{border-color:var(--accent-b);color:var(--accent-b);animation:pulse-pill 2s infinite}
@keyframes pulse-pill{0%,100%{box-shadow:0 0 0 0 rgba(14,165,233,.3)}50%{box-shadow:0 0 0 4px rgba(14,165,233,0)}}

/* ‚îÄ‚îÄ APP BODY ‚îÄ‚îÄ */
.app{flex:1;min-height:0;display:flex;position:relative;z-index:1;overflow:hidden}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid var(--border);background:var(--surface);overflow:hidden}
.sidebar-scroll{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden}
.sidebar-scroll::-webkit-scrollbar{width:3px}
.sidebar-scroll::-webkit-scrollbar-track{background:transparent}
.sidebar-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.sidebar-footer{flex-shrink:0;border-top:1px solid var(--border);padding:14px 16px;display:flex;flex-direction:column;gap:8px;background:var(--surface)}
.sidebar-section{padding:16px;border-bottom:1px solid var(--border)}
.section-label{font-family:'IBM Plex Mono',monospace;font-size:.58rem;letter-spacing:.15em;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px}
.agent-card{background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid var(--border)}
.agent-card:last-child{margin-bottom:0}
.agent-card.agent-a{border-top:3px solid var(--accent-a)}
.agent-card.agent-b{border-top:3px solid var(--accent-b)}
.agent-header{display:flex;align-items:center;gap:7px;margin-bottom:9px}
.agent-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.agent-a .agent-dot{background:var(--accent-a);box-shadow:0 0 5px var(--glow-a)}
.agent-b .agent-dot{background:var(--accent-b);box-shadow:0 0 5px var(--glow-b)}
.agent-name-input{background:transparent;border:none;color:var(--text);font-family:'Syne',sans-serif;font-weight:700;font-size:.82rem;width:100%;outline:none}
.field-label{font-family:'IBM Plex Mono',monospace;font-size:.58rem;color:var(--text-dim);letter-spacing:.08em;margin-bottom:4px}
textarea,input[type="text"],input[type="number"]{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:.7rem;padding:7px 9px;resize:none;outline:none;line-height:1.5;transition:border-color .18s}
textarea:focus,input[type="text"]:focus,input[type="number"]:focus{border-color:var(--accent-a)}
textarea:disabled,input:disabled,select:disabled{opacity:.6;cursor:not-allowed;color:var(--text-dim)}
select{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:.68rem;padding:6px 8px;outline:none;cursor:pointer}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;letter-spacing:.02em;padding:9px 14px;border-radius:8px;border:none;cursor:pointer;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:7px;width:100%}
.btn-primary{background:linear-gradient(135deg,var(--accent-a),#6d28d9);color:white;box-shadow:0 4px 16px rgba(124,58,237,.3)}
.btn-primary:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 22px rgba(124,58,237,.5)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-next{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:white;box-shadow:0 4px 16px rgba(14,165,233,.3)}
.btn-next:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 22px rgba(14,165,233,.5)}
.btn-next:disabled{opacity:.4;cursor:not-allowed}
.btn-stop{background:transparent;border:1px solid #ef4444;color:#ef4444}
.btn-stop:hover{background:rgba(239,68,68,.1)}
.btn-secondary{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
.btn-secondary:hover{border-color:var(--text-dim);color:var(--text)}
.btn-sm{padding:6px 10px;font-size:.7rem;width:auto}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area{flex:1;min-width:0;min-height:0;display:flex;flex-direction:column;overflow:hidden}
.chat-header{flex-shrink:0;padding:0 20px;height:46px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(10,10,15,.5)}
.chat-title{font-size:.8rem;font-weight:700;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-title span{color:var(--text)}
.chat-meta{font-family:'IBM Plex Mono',monospace;font-size:.58rem;color:var(--text-muted);white-space:nowrap;margin-left:10px}
.messages{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;padding:20px 22px 10px;display:flex;flex-direction:column;scroll-behavior:smooth}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-track{background:transparent}
.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.messages::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}
.turn-bar{flex-shrink:0;height:34px;padding:0 22px;border-top:1px solid var(--border);display:flex;align-items:center;gap:14px;font-family:'IBM Plex Mono',monospace;font-size:.6rem;color:var(--text-dim);background:rgba(10,10,15,.6)}
.turn-bar span{color:var(--text)}
.progress-track{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));border-radius:2px;transition:width .4s ease;width:0%}

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
.msg-group{display:flex;flex-direction:column;margin-bottom:16px;animation:msg-in .28s ease}
@keyframes msg-in{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
.msg-group.side-a{align-items:flex-start}
.msg-group.side-b{align-items:flex-end}
.msg-meta{font-family:'IBM Plex Mono',monospace;font-size:.58rem;letter-spacing:.05em;margin-bottom:4px;display:flex;align-items:center;gap:7px}
.side-a .msg-meta{color:var(--accent-a)}
.side-b .msg-meta{color:var(--accent-b)}
.msg-bubble{max-width:min(74%,560px);padding:10px 14px;font-size:.86rem;line-height:1.65}
.side-a .msg-bubble{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--accent-a);border-radius:3px 12px 12px 12px}
.side-b .msg-bubble{background:var(--surface2);border:1px solid var(--border);border-right:3px solid var(--accent-b);border-radius:12px 3px 12px 12px}
.typing-indicator{display:flex;align-items:center;gap:4px;padding:10px 14px}
.typing-dot{width:6px;height:6px;border-radius:50%;animation:typing-bounce 1.2s infinite}
.side-a .typing-dot{background:var(--accent-a)}
.side-b .typing-dot{background:var(--accent-b)}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing-bounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-5px);opacity:1}}
.sys-msg{text-align:center;font-family:'IBM Plex Mono',monospace;font-size:.6rem;color:var(--text-muted);margin:6px 0 14px;letter-spacing:.05em;display:flex;align-items:center;gap:10px;flex-shrink:0}
.sys-msg::before,.sys-msg::after{content:'';flex:1;height:1px;background:var(--border)}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:40px;text-align:center;min-height:200px}
.empty-icon{font-size:2.8rem;opacity:.2}
.empty-text{font-size:.82rem;color:var(--text-dim);max-width:260px;line-height:1.6}

/* conversation list */
.conv-list{display:flex;flex-direction:column;gap:4px}
.conv-item{padding:8px 10px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:space-between;gap:8px}
.conv-item:hover{border-color:var(--accent-a)}
.conv-item.active{border-color:var(--accent-a);background:rgba(124,58,237,.1)}
.conv-item-name{font-size:.75rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-item-date{font-family:'IBM Plex Mono',monospace;font-size:.55rem;color:var(--text-dim);white-space:nowrap}
.conv-del{background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:.9rem;line-height:1;padding:2px 4px;border-radius:4px;flex-shrink:0}
.conv-del:hover{color:#ef4444}
.key-badge{display:inline-flex;align-items:center;gap:4px;font-family:'IBM Plex Mono',monospace;font-size:.55rem;padding:2px 6px;border-radius:10px;border:1px solid var(--border);color:var(--text-dim)}
.key-badge.ok{border-color:rgba(34,197,94,.4);color:#22c55e}
.key-badge.warn{border-color:rgba(234,179,8,.4);color:#eab308}
.key-badge.err{border-color:rgba(239,68,68,.4);color:#ef4444}
.no-keys-warning{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:10px 12px;font-family:'IBM Plex Mono',monospace;font-size:.62rem;color:#f87171;line-height:1.5;cursor:pointer}
.btn-random{background:linear-gradient(135deg,#f59e0b,#d97706);color:white;box-shadow:0 4px 16px rgba(245,158,11,.3)}
.btn-random:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 22px rgba(245,158,11,.5)}
.btn-random:disabled{opacity:.4;cursor:not-allowed}
.random-loading{display:inline-block;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.no-keys-warning:hover{background:rgba(239,68,68,.14)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:680px){
  :root{--sidebar-w:100%}
  .app{flex-direction:column}
  .sidebar{width:100%;flex-shrink:0;max-height:44dvh;border-right:none;border-bottom:1px solid var(--border)}
  .chat-area{flex:1;min-height:0}
  .msg-bubble{max-width:88%}
}
@media(min-width:681px) and (max-width:900px){:root{--sidebar-w:260px}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="overlayLogin">
  <div class="card">
    <div>
      <div class="logo" style="margin-bottom:6px"><div class="logo-icon">‚ö°</div> AI Party</div>
      <div class="card-title">Introduce tu PIN</div>
    </div>
    <div class="card-sub">Escribe tu PIN de 6 d√≠gitos para acceder a tu cuenta y tu historial.</div>
    <input class="pin-input" type="password" id="pinInput" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" />
    <div class="card-error" id="loginError"></div>
    <button class="btn btn-primary" onclick="handleLogin()">Entrar</button>
    <div class="card-divider"></div>
    <div class="card-hint">¬øNo tienes cuenta? <b onclick="switchToRegister()">Crear una nueva</b></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REGISTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay hidden" id="overlayRegister">
  <div class="card">
    <div>
      <div class="logo" style="margin-bottom:6px"><div class="logo-icon">‚ö°</div> AI Party</div>
      <div class="card-title">Crear cuenta</div>
    </div>
    <div class="card-sub">Elige un PIN de 6 d√≠gitos. Gu√°rdalo bien ‚Äî es tu √∫nica contrase√±a y no se puede recuperar.</div>
    <input class="pin-input" type="password" id="pinReg1" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" />
    <input class="pin-input" type="password" id="pinReg2" maxlength="6" placeholder="Repite el PIN" inputmode="numeric" style="margin-top:-8px" />
    <div class="card-error" id="regError"></div>
    <button class="btn btn-primary" onclick="handleRegister()">Crear cuenta</button>
    <div class="card-divider"></div>
    <div class="card-hint">¬øYa tienes cuenta? <b onclick="switchToLogin()">Iniciar sesi√≥n</b></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KEYS OVERLAY (accesible en cualquier momento) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay hidden" id="overlayKeys">
  <div class="card">
    <div>
      <div class="logo" style="margin-bottom:6px"><div class="logo-icon">‚ö°</div> AI Party</div>
      <div class="card-title">Mis API Keys de Groq</div>
    </div>
    <div class="config-notice">
      Cada usuario gestiona sus propias keys.<br>
      Obt√©n keys gratuitas en <code>console.groq.com</code> ‚Üí API Keys ‚Üí Create API Key.<br>
      Si una key alcanza el l√≠mite diario, el sistema pasa autom√°ticamente a la siguiente.
    </div>
    <div>
      <div class="field-label" style="margin-bottom:8px">API KEYS (m√≠nimo 1, m√°ximo 8)</div>
      <div class="keys-list" id="keysList"></div>
      <button class="btn btn-secondary btn-sm" style="margin-top:8px;width:auto" onclick="addKeyRow()">+ A√±adir key</button>
    </div>
    <div class="card-error" id="keysError"></div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="handleSaveKeys()">üíæ Guardar</button>
      <button class="btn btn-secondary" style="width:auto;padding:9px 18px" id="btnCloseKeys" onclick="closeKeysOverlay()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div class="logo"><div class="logo-icon">‚ö°</div> AI Party</div>
  <div class="header-right">
    <div class="status-pill" id="statusPill">INACTIVO</div>
    <button class="hdr-btn keys-btn" onclick="openKeysOverlay()" id="keysBtn">üîë Mis keys</button>
    <button class="hdr-btn" onclick="logout()">Salir</button>
    <div class="hdr-btn" id="userPill" style="cursor:default">‚Äî</div>
  </div>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar-scroll">

      <!-- Conversaciones -->
      <div class="sidebar-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div class="section-label" style="margin-bottom:0">Conversaciones</div>
          <button class="btn btn-secondary btn-sm" onclick="newConversation()">+ Nueva</button>
        </div>
        <div class="conv-list" id="convList">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:.62rem;color:var(--text-muted);padding:6px 2px">Sin conversaciones a√∫n</div>
        </div>
      </div>

      <!-- Agente A -->
      <div class="sidebar-section">
        <div class="section-label">Agente A</div>
        <div class="agent-card agent-a">
          <div class="agent-header"><div class="agent-dot"></div><input class="agent-name-input" type="text" id="nameA" value="" /></div>
          <div class="field-label">ROL / PERSONALIDAD</div>
          <textarea id="roleA" rows="3" placeholder="Describe el rol, personalidad y forma de hablar del Agente A‚Ä¶"></textarea>
        </div>
      </div>

      <!-- Agente B -->
      <div class="sidebar-section">
        <div class="section-label">Agente B</div>
        <div class="agent-card agent-b">
          <div class="agent-header"><div class="agent-dot"></div><input class="agent-name-input" type="text" id="nameB" value="" /></div>
          <div class="field-label">ROL / PERSONALIDAD</div>
          <textarea id="roleB" rows="3" placeholder="Describe el rol, personalidad y forma de hablar del Agente B‚Ä¶"></textarea>
        </div>
      </div>

      <!-- Escenario -->
      <div class="sidebar-section">
        <div class="section-label">Escenario</div>
        <div class="field-label">CONTEXTO</div>
        <textarea id="scenario" rows="3" placeholder="¬øD√≥nde est√°n? ¬øQu√© debaten? ¬øCu√°l es el contexto de la situaci√≥n?"></textarea>
        <div style="margin-top:10px">
          <div class="field-label">MENSAJE INICIAL (opcional)</div>
          <textarea id="firstMessage" rows="2" placeholder="Primer mensaje del Agente A (opcional, si lo dejas vac√≠o lo genera la IA)"></textarea>
        </div>
        <div style="margin-top:10px">
          <div class="field-label">MODELO</div>
          <select id="modelSelect" style="margin-top:4px">
            <option value="llama-3.3-70b-versatile">LLaMA 3.3 70B (recomendado)</option>
            <option value="llama3-8b-8192">LLaMA 3 8B (m√°s r√°pido)</option>
            <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
            <option value="gemma2-9b-it">Gemma 2 9B</option>
          </select>
        </div>
      </div>

    </div>

    <div class="sidebar-footer">
      <div id="noKeysWarning" class="no-keys-warning hidden" onclick="openKeysOverlay()">
        ‚ö† Sin API keys configuradas. Pulsa aqu√≠ para a√±adirlas.
      </div>
      <button class="btn btn-random" id="btnRandom" onclick="generateRandom()">üé≤ Escenario aleatorio</button>
      <button class="btn btn-primary" id="btnStart" onclick="startConversation()">‚ñ∂ Iniciar conversaci√≥n</button>
      <button class="btn btn-next"    id="btnNext"  onclick="nextMessage()"      style="display:none">‚è≠ Siguiente mensaje</button>
      <button class="btn btn-stop"    id="btnStop"  onclick="stopCurrent()"      style="display:none">‚ñ† Detener</button>
      <button class="btn btn-secondary"             onclick="clearAndReset()">‚Ü∫ Nueva desde cero</button>
    </div>
  </aside>

  <main class="chat-area">
    <div class="chat-header">
      <div class="chat-title">
        <span id="chatTitleA">Agente Alpha</span> &amp; <span id="chatTitleB">Agente Beta</span>
      </div>
      <div class="chat-meta" id="chatMeta"></div>
    </div>
    <div class="messages" id="messages">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üí¨</div>
        <div class="empty-text">Crea o selecciona una conversaci√≥n y pulsa <strong>Iniciar</strong>.</div>
      </div>
    </div>
    <div class="turn-bar" id="turnBar" style="display:none">
      <span>Turno <span id="currentTurn">0</span> / <span id="maxTurnsDisplay">‚àû</span></span>
      <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
      <span id="keyStatus" class="key-badge">KEY ‚Äî</span>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, orderBy, getDocs, deleteDoc, serverTimestamp, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß REEMPLAZA CON TU CONFIGURACI√ìN FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA9yWv-2kvEuB9fdRRCxedv-r2ElrjdB1w",
  authDomain: "ai-party-e6532.firebaseapp.com",
  projectId: "ai-party-e6532",
  storageBucket: "ai-party-e6532.firebasestorage.app",
  messagingSenderId: "773125970502",
  appId: "1:773125970502:web:43438241de73e28bb3c847"
};

const app = initializeApp(FIREBASE_CONFIG);
const db  = getFirestore(app);

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentUser  = null;
let currentConv  = null;
let histA = [], histB = [];
let turnCount    = 0;
let isGenerating = false;
let groqKeys     = [];
let currentKeyIdx = 0;

const $ = id => document.getElementById(id);
const escHtml = t => t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
const sleep = ms => new Promise(r => setTimeout(r, ms));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function hashPin(pin) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pin + 'aidialogue_salt'));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

window.switchToRegister = () => {
  $('overlayLogin').classList.add('hidden');
  $('overlayRegister').classList.remove('hidden');
  $('regError').textContent = '';
  $('pinReg1').value = ''; $('pinReg2').value = '';
};
window.switchToLogin = () => {
  $('overlayRegister').classList.add('hidden');
  $('overlayLogin').classList.remove('hidden');
  $('loginError').textContent = '';
  $('pinInput').value = '';
};

window.handleLogin = async () => {
  const pin = $('pinInput').value.trim();
  if (pin.length !== 6 || !/^\d+$/.test(pin)) { $('loginError').textContent = 'El PIN debe tener exactamente 6 d√≠gitos.'; return; }
  $('loginError').textContent = 'Verificando‚Ä¶';
  try {
    const h = await hashPin(pin);
    const uSnap = await getDoc(doc(db, 'users', h));
    if (!uSnap.exists()) { $('loginError').textContent = 'PIN incorrecto o cuenta no encontrada.'; return; }
    currentUser = { pin, uid: h };
    $('userPill').textContent = `PIN: ${pin.slice(0,2)}‚Ä¢‚Ä¢‚Ä¢‚Ä¢`;
    $('overlayLogin').classList.add('hidden');
    await loadUserData();
  } catch(e) {
    $('loginError').textContent = 'Error de conexi√≥n. Revisa tu configuraci√≥n Firebase.';
    console.error(e);
  }
};

window.handleRegister = async () => {
  const p1 = $('pinReg1').value.trim(), p2 = $('pinReg2').value.trim();
  if (p1.length !== 6 || !/^\d+$/.test(p1)) { $('regError').textContent = 'El PIN debe tener exactamente 6 d√≠gitos.'; return; }
  if (p1 !== p2) { $('regError').textContent = 'Los PINes no coinciden.'; return; }
  $('regError').textContent = 'Creando cuenta‚Ä¶';
  try {
    const h = await hashPin(p1);
    const uSnap = await getDoc(doc(db, 'users', h));
    if (uSnap.exists()) { $('regError').textContent = 'Este PIN ya est√° en uso. Elige otro.'; return; }
    await setDoc(doc(db, 'users', h), { createdAt: serverTimestamp(), groqKeys: [] });
    currentUser = { pin: p1, uid: h };
    $('userPill').textContent = `PIN: ${p1.slice(0,2)}‚Ä¢‚Ä¢‚Ä¢‚Ä¢`;
    $('overlayRegister').classList.add('hidden');
    await loadUserData();
  } catch(e) {
    $('regError').textContent = 'Error de conexi√≥n. Revisa tu configuraci√≥n Firebase.';
    console.error(e);
  }
};

window.logout = () => {
  if (!confirm('¬øCerrar sesi√≥n?')) return;
  currentUser = null; currentConv = null; histA = []; histB = []; groqKeys = [];
  $('overlayLogin').classList.remove('hidden');
  $('pinInput').value = ''; $('loginError').textContent = '';
  clearChatUI();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYS MANAGEMENT (per user)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadUserData() {
  const snap = await getDoc(doc(db, 'users', currentUser.uid));
  groqKeys = snap.data()?.groqKeys || [];
  currentKeyIdx = 0;
  updateKeysUI();
  await loadConversations();

  // If no keys yet, open the keys overlay automatically
  if (groqKeys.length === 0) {
    openKeysOverlayInternal(true); // first time, can't cancel
  }
}

function updateKeysUI() {
  if (groqKeys.length === 0) {
    $('noKeysWarning').classList.remove('hidden');
  } else {
    $('noKeysWarning').classList.add('hidden');
  }
  updateKeyBadge(groqKeys.length > 0 ? 'OK' : '‚Äî', groqKeys.length > 0 ? 'ok' : '');
}

window.openKeysOverlay = () => openKeysOverlayInternal(false);

function openKeysOverlayInternal(firstTime) {
  // Populate list with current keys (masked)
  const list = $('keysList');
  list.innerHTML = '';
  if (groqKeys.length === 0) {
    addKeyRowWith('');
    addKeyRowWith('');
  } else {
    groqKeys.forEach(k => addKeyRowWith(k));
  }
  $('keysError').textContent = '';
  // Hide cancel button if first time (must add at least one key)
  $('btnCloseKeys').style.display = firstTime ? 'none' : 'flex';
  $('overlayKeys').classList.remove('hidden');
}

window.closeKeysOverlay = () => {
  $('overlayKeys').classList.add('hidden');
};

function addKeyRowWith(val) {
  const list = $('keysList');
  if (list.children.length >= 8) return;
  const row = document.createElement('div');
  row.className = 'key-row';
  const isValid = val.startsWith('gsk_') && val.length > 10;
  row.innerHTML = `
    <input type="text" placeholder="gsk_..." value="${escHtml(val)}" />
    ${val ? `<span class="key-status ${isValid?'ok':''}">${isValid?'‚úì':'?'}</span>` : ''}
    <button class="del-btn" onclick="removeKeyRow(this)">‚úï</button>`;
  // Live validation
  row.querySelector('input').addEventListener('input', e => {
    const v = e.target.value.trim();
    let st = row.querySelector('.key-status');
    if (!st) { st = document.createElement('span'); st.className='key-status'; row.insertBefore(st, row.querySelector('.del-btn')); }
    if (v.startsWith('gsk_') && v.length > 10) { st.textContent='‚úì'; st.className='key-status ok'; }
    else if (v.length > 0) { st.textContent='?'; st.className='key-status'; }
    else { st.textContent=''; }
  });
  list.appendChild(row);
}

window.addKeyRow = () => addKeyRowWith('');

window.removeKeyRow = btn => {
  const list = $('keysList');
  if (list.children.length <= 1) return;
  btn.parentElement.remove();
};

window.handleSaveKeys = async () => {
  const inputs = [...$('keysList').querySelectorAll('input')];
  const keys = inputs.map(i => i.value.trim()).filter(k => k.startsWith('gsk_') && k.length > 10);
  if (keys.length === 0) { $('keysError').textContent = 'Introduce al menos una API key v√°lida (empieza por gsk_).'; return; }
  $('keysError').textContent = 'Guardando‚Ä¶';
  try {
    await updateDoc(doc(db, 'users', currentUser.uid), { groqKeys: keys });
    groqKeys = keys;
    currentKeyIdx = 0;
    updateKeysUI();
    $('overlayKeys').classList.add('hidden');
    $('keysError').textContent = '';
  } catch(e) {
    $('keysError').textContent = 'Error al guardar. Int√©ntalo de nuevo.';
    console.error(e);
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROQ KEY ROTATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function currentKey() {
  if (!groqKeys.length) throw new Error('No tienes API keys configuradas. Pulsa "Mis keys" para a√±adirlas.');
  return groqKeys[currentKeyIdx % groqKeys.length];
}
function rotateKey() {
  currentKeyIdx = (currentKeyIdx + 1) % groqKeys.length;
  return groqKeys[currentKeyIdx];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERSATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadConversations() {
  try {
    // Try with ordering first (requires Firestore index)
    let convs = [];
    try {
      const q = query(collection(db,'conversations'), where('uid','==',currentUser.uid), orderBy('updatedAt','desc'));
      const snap = await getDocs(q);
      snap.forEach(d => convs.push({ id:d.id, ...d.data() }));
    } catch(indexErr) {
      // Index not ready yet ‚Äî fallback: load without ordering
      console.warn('√çndice no disponible, cargando sin orden:', indexErr.message);
      const q2 = query(collection(db,'conversations'), where('uid','==',currentUser.uid));
      const snap2 = await getDocs(q2);
      snap2.forEach(d => convs.push({ id:d.id, ...d.data() }));
      // Sort client-side
      convs.sort((a,b) => {
        const ta = a.updatedAt?.toMillis?.() || 0;
        const tb = b.updatedAt?.toMillis?.() || 0;
        return tb - ta;
      });
    }
    renderConvList(convs);
  } catch(e) {
    console.error('Error cargando conversaciones:', e);
    renderConvList([]);
  }
}

function renderConvList(convs) {
  const el = $('convList');
  if (!convs.length) {
    el.innerHTML = `<div style="font-family:'IBM Plex Mono',monospace;font-size:.62rem;color:var(--text-muted);padding:6px 2px">Sin conversaciones a√∫n</div>`;
    return;
  }
  el.innerHTML = convs.map(c => {
    const date = c.updatedAt?.toDate ? c.updatedAt.toDate().toLocaleDateString('es',{day:'2-digit',month:'short'}) : '‚Äî';
    const name = `${c.nameA||'A'} & ${c.nameB||'B'}`;
    const active = currentConv?.id === c.id ? ' active' : '';
    return `<div class="conv-item${active}" onclick="selectConversation('${c.id}')">
      <div style="overflow:hidden">
        <div class="conv-item-name">${escHtml(name)}</div>
        <div class="conv-item-date">${date} ¬∑ ${c.turnCount||0} turnos</div>
      </div>
      <button class="conv-del" onclick="event.stopPropagation();deleteConversation('${c.id}')">üóë</button>
    </div>`;
  }).join('');
}

window.newConversation = () => {
  currentConv = null; histA = []; histB = []; turnCount = 0;
  clearChatUI();
  ['nameA','nameB'].forEach(id => $(id).value = '');
  ['roleA','roleB','scenario','firstMessage'].forEach(id => $(id).value = '');
  updateTitles();
  unlockConversationFields();
};

window.selectConversation = async (id) => {
  try {
    const snap = await getDoc(doc(db,'conversations',id));
    if (!snap.exists()) return;
    const data = snap.data();
    currentConv = { id, ...data };
    histA = data.histA || []; histB = data.histB || [];
    turnCount = data.turnCount || 0;
    $('nameA').value = data.nameA||'Agente A'; $('nameB').value = data.nameB||'Agente B';
    $('roleA').value = data.roleA||''; $('roleB').value = data.roleB||'';
    $('scenario').value = data.scenario||'';
    if (data.model) $('modelSelect').value = data.model;
    updateTitles();
    clearChatUI(false);
    (data.messages||[]).forEach(m => addMessageRaw(m.side,m.name,m.text,m.time));
    addSysMsg(`‚Äî Conversaci√≥n cargada ¬∑ ${turnCount} turnos ‚Äî`);
    $('chatMeta').textContent = `${turnCount} turnos guardados`;
    $('btnStart').style.display = 'none';
    $('btnNext').style.display = 'flex';
    $('btnStop').style.display = 'none';
    $('turnBar').style.display = 'flex';
    setProgress(turnCount);
    lockConversationFields();
    await loadConversations();
  } catch(e) { console.error(e); }
};

window.deleteConversation = async (id) => {
  if (!confirm('¬øEliminar esta conversaci√≥n?')) return;
  await deleteDoc(doc(db,'conversations',id));
  if (currentConv?.id === id) { currentConv=null; histA=[]; histB=[]; clearChatUI(); }
  await loadConversations();
};

async function saveConversation(newMsg) {
  const convData = {
    uid: currentUser.uid,
    nameA: $('nameA').value, nameB: $('nameB').value,
    roleA: $('roleA').value, roleB: $('roleB').value,
    scenario: $('scenario').value, model: $('modelSelect').value,
    histA, histB, turnCount, updatedAt: serverTimestamp()
  };
  try {
    if (!currentConv) {
      const ref = await addDoc(collection(db,'conversations'), { ...convData, messages: newMsg?[newMsg]:[], createdAt: serverTimestamp() });
      currentConv = { id: ref.id, ...convData };
    } else {
      const upd = { ...convData };
      if (newMsg) upd.messages = arrayUnion(newMsg);
      await updateDoc(doc(db,'conversations',currentConv.id), upd);
      currentConv = { ...currentConv, ...convData };
    }
    await loadConversations();
  } catch(e) { console.error('Error guardando:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI CALL with key rotation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callAI(systemPrompt, messages, attempt = 0) {
  if (!groqKeys.length) throw new Error('No tienes API keys configuradas. Pulsa "üîë Mis keys" en el header.');
  const model = $('modelSelect').value;
  const key = attempt === 0 ? currentKey() : rotateKey();
  updateKeyBadge('...', 'warn');

  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
    body: JSON.stringify({ model, max_tokens:400, messages:[{role:'system',content:systemPrompt},...messages] })
  });

  if (res.status === 429) {
    if (attempt < groqKeys.length - 1) {
      updateKeyBadge('ROTANDO', 'warn');
      await sleep(500);
      return callAI(systemPrompt, messages, attempt + 1);
    }
    updateKeyBadge('L√çMITE', 'err');
    throw new Error('Todas tus keys han alcanzado el l√≠mite de hoy. La conversaci√≥n est√° guardada ‚Äî vuelve ma√±ana o a√±ade m√°s keys desde "üîë Mis keys".');
  }
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    updateKeyBadge('ERROR', 'err');
    throw new Error(err.error?.message || `Error HTTP ${res.status}`);
  }

  updateKeyBadge('OK', 'ok');
  const data = await res.json();
  return data.choices[0].message.content.trim();
}

function updateKeyBadge(text, cls) {
  const el = $('keyStatus');
  el.textContent = `KEY ${text}`;
  el.className = `key-badge ${cls||''}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DIALOGUE FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSys(role, otherName, scenario) {
  return `${role}\n\nContexto: ${scenario}\n\nTu interlocutor se llama ${otherName}. Responde de forma natural y concisa (2-4 frases). Sin asteriscos ni formato especial.`;
}


function lockConversationFields() {
  // Disable all config fields once conversation starts
  ['nameA','nameB','roleA','roleB','scenario','firstMessage','modelSelect'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = true;
  });
  const btnRandom = document.getElementById('btnRandom');
  if (btnRandom) btnRandom.disabled = true;
}

function unlockConversationFields() {
  ['nameA','nameB','roleA','roleB','scenario','firstMessage','modelSelect'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = false;
  });
  const btnRandom = document.getElementById('btnRandom');
  if (btnRandom) btnRandom.disabled = false;
}

window.generateRandom = async () => {
  if (!groqKeys.length) { openKeysOverlayInternal(false); return; }
  const btn = $('btnRandom');
  btn.disabled = true;
  btn.innerHTML = '<span class="random-loading">‚ü≥</span> Generando‚Ä¶';

  // Pick random seeds to force variety
  const epochs = ['Antigua Grecia','Imperio Romano','Edad Media','Renacimiento','siglo XVII','siglo XIX','a√±os 20','a√±os 60','a√±o 2150','era post-apocal√≠ptica','prehistoria','futuro lejano'];
  const domains = ['gastronom√≠a','astrof√≠sica','pol√≠tica','poes√≠a','inteligencia artificial','magia','econom√≠a','biolog√≠a marina','arquitectura','filosof√≠a budista','m√∫sica jazz','medicina medieval','videojuegos','diplomacia intergal√°ctica','alquimia','neurociencia','teatro kabuki','criptograf√≠a','mitolog√≠a n√≥rdica','dise√±o de moda'];
  const formats = ['debate tenso','conversaci√≥n √≠ntima y filos√≥fica','negociaci√≥n diplom√°tica','interrogatorio','colaboraci√≥n creativa','juicio','confesi√≥n','entrevista de trabajo absurda','partida de ajedrez verbal','sesi√≥n de terapia','concurso de ingenio','reuni√≥n de crisis'];
  const archetypes = ['un villano con buenas intenciones','una IA que cree ser humana','un dios aburrido','un detective c√≠nico','una bruja pragm√°tica','un robot sentimental','un revolucionario pacifista','un artista egoc√©ntrico','un cient√≠fico loco pero brillante','un fantasma del pasado','un viajero del tiempo confundido','una or√°culo ambigua','un pirata fil√≥sofo','una princesa que odia su rol','un explorador perdido'];
  const rand = arr => arr[Math.floor(Math.random() * arr.length)];
  const seed = `√âpoca: ${rand(epochs)} | √Åmbito: ${rand(domains)} | Formato: ${rand(formats)} | Arquetipo A: ${rand(archetypes)} | Arquetipo B: ${rand(archetypes)}`;

  const prompt = `Genera un escenario √öNICO e inesperado para una conversaci√≥n entre dos personajes/IAs.
Semilla aleatoria (DEBES usarla como inspiraci√≥n, no ignorarla): ${seed}

Devuelve SOLO un objeto JSON v√°lido, sin texto extra, sin markdown, sin bloques de c√≥digo:
{
  "nameA": "nombre propio corto y evocador (puede ser hist√≥rico, ficticio, metaf√≥rico)",
  "roleA": "2-3 frases en segunda persona que empiecen por Eres. Define voz, obsesiones, forma de ver el mundo",
  "nameB": "nombre propio corto y evocador",
  "roleB": "2-3 frases en segunda persona que empiecen por Eres. Define voz, obsesiones, forma de ver el mundo",
  "scenario": "2-3 frases describiendo la situaci√≥n concreta, el lugar, y la tensi√≥n o pregunta central del encuentro",
  "firstMessage": "primer mensaje de nameA, natural, en su voz caracter√≠stica, que abre la conversaci√≥n de forma memorable"
}`;

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${currentKey()}` },
      body: JSON.stringify({
        model: $('modelSelect').value,
        max_tokens: 600,
        temperature: 1.2,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    if (!res.ok) throw new Error('Error de API');
    const data = await res.json();
    let raw = data.choices[0].message.content.trim();
    // Strip markdown code fences if present
    raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'').trim();
    const parsed = JSON.parse(raw);

    // Fill in all fields
    if (parsed.nameA)       { $('nameA').value = parsed.nameA; }
    if (parsed.roleA)       { $('roleA').value = parsed.roleA; }
    if (parsed.nameB)       { $('nameB').value = parsed.nameB; }
    if (parsed.roleB)       { $('roleB').value = parsed.roleB; }
    if (parsed.scenario)    { $('scenario').value = parsed.scenario; }
    if (parsed.firstMessage){ $('firstMessage').value = parsed.firstMessage; }
    updateTitles();

    // Visual feedback
    btn.innerHTML = '‚úì Listo';
    setTimeout(() => { btn.innerHTML = 'üé≤ Escenario aleatorio'; btn.disabled = false; }, 1200);
  } catch(e) {
    console.error('Error generando escenario:', e);
    btn.innerHTML = '‚ö† Error, reintentar';
    setTimeout(() => { btn.innerHTML = 'üé≤ Escenario aleatorio'; btn.disabled = false; }, 2000);
  }
};

window.startConversation = async () => {
  if (!currentUser) return;
  if (!groqKeys.length) { openKeysOverlayInternal(true); return; }
  const nameA = $('nameA').value||'Agente A', nameB = $('nameB').value||'Agente B';
  const firstMsg = $('firstMessage').value.trim();
  histA=[]; histB=[]; turnCount=0; currentConv=null;
  clearChatUI(false);
  addSysMsg(`‚Äî Inicio: ${nameA} & ${nameB} ‚Äî`);
  $('turnBar').style.display='flex'; setProgress(0);
  $('btnStart').style.display='none'; $('btnNext').style.display='none'; $('btnStop').style.display='none';
  setStatus('INICIANDO','running');
  const sysA = buildSys($('roleA').value, nameB, $('scenario').value);
  try {
    let msg='';
    if (firstMsg) {
      msg=firstMsg; const t=timeStr();
      addMessageRaw('a',nameA,msg,t);
      histA.push({role:'assistant',content:msg}); histB.push({role:'user',content:msg});
      turnCount++; await saveConversation({side:'a',name:nameA,text:msg,time:t});
    } else {
      showTyping('a',nameA);
      histA.push({role:'user',content:`Inicia la conversaci√≥n con ${nameB} seg√∫n el contexto. Solo una intervenci√≥n.`});
      msg = await callAI(sysA, histA);
      removeTyping();
      histA[histA.length-1]={role:'user',content:'Inicia la conversaci√≥n.'};
      histA.push({role:'assistant',content:msg}); histB.push({role:'user',content:msg});
      const t=timeStr(); addMessageRaw('a',nameA,msg,t);
      turnCount++; await saveConversation({side:'a',name:nameA,text:msg,time:t});
    }
    setProgress(turnCount);
    $('chatMeta').textContent=`${turnCount} turnos`;
    setStatus('ESPERANDO');
    $('btnNext').style.display='flex';
    lockConversationFields();
  } catch(err) {
    removeTyping(); addSysMsg(`‚ö† ${err.message}`); setStatus('ERROR');
    $('btnStart').style.display='flex';
  }
};

window.nextMessage = async () => {
  if (!currentUser || isGenerating) return;
  if (!groqKeys.length) { openKeysOverlayInternal(false); return; }
  isGenerating = true;
  const nameA = $('nameA').value||'Agente A', nameB = $('nameB').value||'Agente B';
  const sysA = buildSys($('roleA').value, nameB, $('scenario').value);
  const sysB = buildSys($('roleB').value, nameA, $('scenario').value);
  $('btnNext').disabled=true; setStatus('EN CURSO','running');

  // Determine whose turn it is based on history (not counter).
  // A's history last entry being 'assistant' means A just spoke ‚Üí B goes next.
  const lastSpeakerWasA = histA.length > 0 && histA[histA.length - 1].role === 'assistant';
  const side = lastSpeakerWasA ? 'b' : 'a';
  const name = side==='a' ? nameA : nameB;
  const hist = side==='a' ? histA : histB;
  const sys  = side==='a' ? sysA  : sysB;
  const otherHist = side==='a' ? histB : histA;

  try {
    showTyping(side,name);
    const reply = await callAI(sys, hist);
    removeTyping();
    hist.push({role:'assistant',content:reply});
    otherHist.push({role:'user',content:reply});
    const t=timeStr(); addMessageRaw(side,name,reply,t);
    turnCount++; setProgress(turnCount);
    $('chatMeta').textContent=`${turnCount} turnos`;
    await saveConversation({side,name,text:reply,time:t});
    setStatus('ESPERANDO');
  } catch(err) {
    removeTyping(); addSysMsg(`‚ö† ${err.message}`); setStatus('ERROR');
  }
  $('btnNext').disabled=false; isGenerating=false;
};

window.stopCurrent = () => {
  isGenerating=false; removeTyping(); setStatus('INACTIVO');
  $('btnStop').style.display='none'; $('btnNext').style.display='flex';
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTitles() {
  $('chatTitleA').textContent = $('nameA').value||'Agente A';
  $('chatTitleB').textContent = $('nameB').value||'Agente B';
}
['nameA','nameB'].forEach(id => $(id).addEventListener('input',updateTitles));

function clearChatUI(showEmpty=true) {
  $('messages').innerHTML = showEmpty
    ? `<div class="empty-state" id="emptyState"><div class="empty-icon">üí¨</div><div class="empty-text">Crea o selecciona una conversaci√≥n del historial.</div></div>`
    : '';
  $('turnBar').style.display='none'; $('chatMeta').textContent='';
  setProgress(0);
  $('btnStart').style.display='flex'; $('btnNext').style.display='none'; $('btnStop').style.display='none';
  setStatus('INACTIVO');
}

window.clearAndReset = () => {
  if (!confirm('¬øEmpezar desde cero? La conversaci√≥n guardada no se borra.')) return;
  currentConv=null; histA=[]; histB=[]; turnCount=0; clearChatUI(); unlockConversationFields();
};

function addMessageRaw(side,name,text,time) {
  const empty=$('emptyState'); if(empty) empty.remove();
  const msgs=$('messages'), div=document.createElement('div');
  div.className=`msg-group side-${side}`;
  div.innerHTML=`<div class="msg-meta">${escHtml(name.toUpperCase())}<span style="opacity:.4">${time||''}</span></div><div class="msg-bubble">${escHtml(text)}</div>`;
  msgs.appendChild(div); msgs.scrollTop=msgs.scrollHeight;
}

function showTyping(side,name) {
  const msgs=$('messages'), div=document.createElement('div');
  div.className=`msg-group side-${side}`; div.id='typing-indicator';
  div.innerHTML=`<div class="msg-meta">${escHtml(name.toUpperCase())}<span style="opacity:.4;font-style:italic">escribiendo‚Ä¶</span></div><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  msgs.appendChild(div); msgs.scrollTop=msgs.scrollHeight;
}
function removeTyping() { const e=$('typing-indicator'); if(e) e.remove(); }

function addSysMsg(text) {
  const div=document.createElement('div'); div.className='sys-msg'; div.textContent=text;
  $('messages').appendChild(div); $('messages').scrollTop=$('messages').scrollHeight;
}

function setStatus(text,cls) {
  const el=$('statusPill'); el.textContent=text;
  el.className='status-pill'+(cls?' '+cls:'');
}

function setProgress(cur) {
  $('currentTurn').textContent=cur; $('progressFill').style.width='0%';
}

function timeStr() { return new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); }

// Boot
$('overlayLogin').classList.remove('hidden');
</script>
</body>
</html>